<!DOCTYPE html>
<html>
<head>
    <title>AR Snow Effect</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.133.1/build/three.min.js"></script>
</head>
<body>
    <video id="video" autoplay playsinline style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;"></video>
    <canvas id="canvas" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%;"></canvas>
    <button id="capture" style="position: absolute; top: 10px; left: 10px; z-index: 10;">Capture Photo</button>
    <img id="photo" alt="The screen capture will appear in this box." style="display: none;">

    <script>
        // 設置相機
        navigator.mediaDevices.getUserMedia({ video: true })
        .then(function(stream) {
            const video = document.getElementById('video');
            video.srcObject = stream;
        })
        .catch(function(err) {
            console.log("An error occurred: " + err);
        });

        const scene = new THREE.Scene();
        const camera = new THREE.OrthographicCamera( window.innerWidth / - 2, window.innerWidth / 2, window.innerHeight / 2, window.innerHeight / - 2, -1000, 1000 );
        camera.position.z = 100;

        const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('canvas'), alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);

        // 雪花粒子
        const snowGeo = new THREE.BufferGeometry();
        const particles = 500;

        const positions = new Float32Array( particles * 3 );
        const velocities = new Float32Array( particles * 3 );

        for (let i = 0; i < positions.length; i += 3) {
            positions[i] = Math.random() * window.innerWidth - window.innerWidth / 2;
            positions[i + 1] = Math.random() * window.innerHeight - window.innerHeight / 2;
            positions[i + 2] = Math.random() * 500;

            velocities[i] = 0;
            velocities[i + 1] = -Math.random();
            velocities[i + 2] = 0;
        }

        snowGeo.setAttribute( 'position', new THREE.Float32BufferAttribute( positions, 3 ) );

        const sprite = new THREE.TextureLoader().load('snowflake.png');
        const snowMat = new THREE.PointsMaterial({
            size: 8,
            map: sprite,
            blending: THREE.AdditiveBlending,
            depthTest: false,
            transparent: true
        });

        const snow = new THREE.Points(snowGeo, snowMat);
        scene.add(snow);

        function animate() {
            requestAnimationFrame(animate);
            const positions = snow.geometry.attributes.position.array;
            for (let i = 1; i < positions.length; i += 3) {
                if (positions[i] < -window.innerHeight / 2) {
                    positions[i] = window.innerHeight / 2;
                }
                positions[i] += velocities[i];
            }
            snow.geometry.attributes.position.needsUpdate = true;
            renderer.render(scene, camera);
        }
        animate();

        // 拍照功能
        document.getElementById('capture').addEventListener('click', function() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            document.getElementById('photo').src = canvas.toDataURL('image/png');
            document.getElementById('photo').style.display = 'block';
        });
    </script>
</body>
</html>